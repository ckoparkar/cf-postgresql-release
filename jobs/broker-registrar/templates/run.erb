#!/bin/bash

set -e
set -u

POSTGRESQL_HOST=<%= properties.postgresql.host  %>
POSTGRESQL_USERNAME=<%= properties.postgresql.username %>
POSTGRESQL_PASSWORD=<%= properties.postgresql.password %>
POSTGRESQL_PORT=<%= properties.postgresql.port %>

CF_USERNAME=<%= properties.cf.username %>
CF_PASSWORD=<%= properties.cf.password %>
CF_API=<%= properties.cf.api %>

export PATH=$PATH:/var/vcap/packages/cf_cli_6.10.0/bin

cd /var/vcap/packages/cf_postgresql_broker

cf api $CF_API
cf auth $CF_USERNAME $CF_PASSWORD
cf create-org system
cf target -o system
cf create-space postgresql-broker
cf target -s postgresql-broker
cf push postgresql-broker-app

cf set-env postgresql-broker-app POSTGRESQL_HOST $POSTGRESQL_HOST
cf set-env postgresql-broker-app POSTGRESQL_USERNAME $POSTGRESQL_USERNAME
cf set-env postgresql-broker-app POSTGRESQL_PASSWORD $POSTGRESQL_PASSWORD
cf set-env postgresql-broker-app POSTGRESQL_PORT $POSTGRESQL_PORT

cf restage postgresql-broker-app

exit 0
